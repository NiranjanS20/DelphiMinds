<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Market Insights - DelphiMinds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/auth-utils.js"></script>
</head>
<body class="bg-blue-50">
    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-blue-900 shadow-lg transform -translate-x-full transition-transform duration-300 ease-in-out" id="sidebar">
        <div class="flex items-center justify-center h-16 bg-blue-900">
            <a href="/" class="text-xl font-bold text-white hover:text-cyan-200 transition-colors">
                DelphiMinds
            </a>
        </div>
        <nav class="mt-8">
            <div class="px-4 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">📊</span> Dashboard
                </a>
                <a href="insights.html" class="flex items-center px-4 py-2 text-white bg-blue-800 rounded-lg">
                    <span class="mr-3">📈</span> Job Insights
                </a>
                <a href="community.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">👥</span> Community
                </a>
                <a href="roadmap.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">🗺️</span> Career Roadmap
                </a>
                <a href="resume.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">📄</span> Resume Analyzer
                </a>
                <a href="psychometric.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">🧠</span> Career Test
                </a>
                <a href="chat.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">💬</span> AI Chatbot
                </a>
                <a href="gamification.html" class="flex items-center px-4 py-2 text-gray-200 hover:bg-blue-800 hover:text-white rounded-lg">
                    <span class="mr-3">🏆</span> Achievements
                </a>
            </div>
        </nav>
        <div class="absolute bottom-0 w-full p-4">
            <button onclick="logout()" class="w-full flex items-center px-4 py-2 text-red-400 hover:bg-red-900 hover:text-red-200 rounded-lg">
                <span class="mr-3">🚪</span> Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Top Navigation -->
        <nav class="bg-blue-900 shadow-sm border-b border-blue-800">
            <div class="flex items-center justify-between h-16 px-4">
                <button onclick="toggleSidebar()" class="p-2 rounded-md text-gray-200 hover:text-white hover:bg-blue-800">
                    ☰
                </button>
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-semibold text-white">Job Market Insights</h1>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <div class="flex-1 p-6">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Job Market Insights</h1>
                <p class="mt-2 text-gray-600">Real-time data on job trends, skill demand, and salary insights</p>
            </div>

        <!-- Job Trends Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Job Market Trends</h2>
            <canvas id="jobTrendsChart" width="400" height="200"></canvas>
        </div>

        <!-- Skill Demand Chart -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Top In-Demand Skills</h2>
            <canvas id="skillDemandChart" width="400" height="200"></canvas>
        </div>

        <!-- Salary Insights -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Salary Insights</h2>
            <div id="salaryInsights" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Salary data will be loaded here -->
            </div>
        </div>

        <!-- Job Listings -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Recent Job Postings</h2>
            <div id="jobListings" class="space-y-4">
                <!-- Job listings will be loaded here -->
            </div>
        </div>
    </div>
    </div>

    <script src="/app.js"></script>
    <script>
        let jobTrendsChart, skillDemandChart;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        async function loadInsights() {
            try {
                const token = localStorage.getItem('access_token');
                
                // Show demo data (since insights API might not be implemented)
                showDemoData();
                
            } catch (error) {
                console.error('Error loading insights:', error);
                // Fallback to demo data on error
                showDemoData();
            }
        }
        
        function showDemoData() {
            console.log('Showing demo data for insights page');
            
            // Demo data for when user is not authenticated or API fails
            const demoData = {
                market_trends: [
                    { role: 'Software Engineer', demand_level: 'High', growth_rate: '+8%', job_count: 1250 },
                    { role: 'Data Scientist', demand_level: 'High', growth_rate: '+12%', job_count: 890 },
                    { role: 'Product Manager', demand_level: 'Medium', growth_rate: '+6%', job_count: 650 }
                ],
                top_skills: [
                    { skill: 'Python', demand_percentage: 85, growth: '+12%' },
                    { skill: 'JavaScript', demand_percentage: 82, growth: '+8%' },
                    { skill: 'React', demand_percentage: 75, growth: '+15%' },
                    { skill: 'AWS', demand_percentage: 70, growth: '+20%' },
                    { skill: 'SQL', demand_percentage: 68, growth: '+5%' },
                    { skill: 'Docker', demand_percentage: 60, growth: '+25%' }
                ],
                salary_insights: [
                    { role: 'Software Engineer', average_salary: 110000, currency: 'USD' },
                    { role: 'Data Scientist', average_salary: 125000, currency: 'USD' },
                    { role: 'Product Manager', average_salary: 140000, currency: 'USD' }
                ],
                recent_jobs: [
                    {
                        title: 'Senior Software Engineer',
                        company: 'TechCorp Inc.',
                        location: 'San Francisco, CA',
                        type: 'Full-time',
                        skills: ['Python', 'React', 'AWS']
                    },
                    {
                        title: 'Data Scientist',
                        company: 'DataTech Solutions',
                        location: 'New York, NY', 
                        type: 'Full-time',
                        skills: ['Python', 'Machine Learning', 'SQL']
                    },
                    {
                        title: 'Frontend Developer',
                        company: 'StartupXYZ',
                        location: 'Austin, TX',
                        type: 'Remote',
                        skills: ['JavaScript', 'React', 'TypeScript']
                    },
                    {
                        title: 'DevOps Engineer',
                        company: 'CloudFirst',
                        location: 'Seattle, WA',
                        type: 'Hybrid',
                        skills: ['Docker', 'Kubernetes', 'AWS']
                    }
                ]
            };
            
            updateChartsFromInsights(demoData);
            updateSalaryInsights(demoData.salary_insights);
            updateJobListings(demoData.recent_jobs);
        }

        function updateChartsFromInsights(data) {
            // Job Trends Chart - showing role demand
            const trendsCtx = document.getElementById('jobTrendsChart').getContext('2d');
            if (jobTrendsChart) jobTrendsChart.destroy();
            
            const trendData = data.market_trends || [];
            
            jobTrendsChart = new Chart(trendsCtx, {
                type: 'bar',
                data: {
                    labels: trendData.map(t => t.role) || ['Software Engineer', 'Data Scientist', 'Product Manager'],
                    datasets: [{
                        label: 'Job Openings',
                        data: trendData.map(t => t.job_count) || [1250, 890, 650],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(168, 85, 247)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Job Market Demand by Role'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Skill Demand Chart
            const skillsCtx = document.getElementById('skillDemandChart').getContext('2d');
            if (skillDemandChart) skillDemandChart.destroy();
            
            const skillData = data.top_skills || [];
            
            skillDemandChart = new Chart(skillsCtx, {
                type: 'doughnut',
                data: {
                    labels: skillData.slice(0, 6).map(s => s.skill) || ['Python', 'JavaScript', 'React', 'AWS', 'SQL', 'Docker'],
                    datasets: [{
                        label: 'Demand %',
                        data: skillData.slice(0, 6).map(s => s.demand_percentage) || [85, 82, 75, 70, 68, 60],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 205, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top In-Demand Skills'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateSalaryInsights(salaryData) {
            const container = document.getElementById('salaryInsights');
            
            if (!salaryData || salaryData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-3 text-center">No salary data available</p>';
                return;
            }
            
            container.innerHTML = salaryData.map(salary => `
                <div class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
                    <h3 class="font-semibold text-lg text-gray-900 mb-2">${salary.role}</h3>
                    <p class="text-3xl font-bold text-green-600 mb-1">$${(salary.average_salary || 0).toLocaleString()}</p>
                    <p class="text-sm text-gray-600">${salary.currency || 'USD'} • Average</p>
                    <div class="mt-3 text-xs text-gray-500">
                        <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded">Market Rate</span>
                    </div>
                </div>
            `).join('');
            
            // Add a summary card if we have multiple salaries
            if (salaryData.length > 1) {
                const avgSalary = salaryData.reduce((sum, s) => sum + (s.average_salary || 0), 0) / salaryData.length;
                container.innerHTML += `
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-lg text-gray-900 mb-2">Market Average</h3>
                        <p class="text-3xl font-bold text-purple-600 mb-1">$${Math.round(avgSalary).toLocaleString()}</p>
                        <p class="text-sm text-gray-600">USD • Across ${salaryData.length} roles</p>
                        <div class="mt-3 text-xs text-gray-500">
                            <span class="inline-block bg-purple-100 text-purple-800 px-2 py-1 rounded">Overall Trend</span>
                        </div>
                    </div>
                `;
            }
        }

        function updateJobListings(jobListings) {
            const container = document.getElementById('jobListings');
            
            if (!jobListings || jobListings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center">No recent job postings available</p>';
                return;
            }
            
            container.innerHTML = jobListings.map(job => `
                <div class="border rounded-lg p-6 hover:shadow-lg transition-shadow bg-white">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-semibold text-xl text-gray-900 mb-1">${job.title}</h3>
                            <p class="text-lg text-blue-600 font-medium">${job.company}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                ${job.type || 'Full-time'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center text-gray-600 mb-3">
                        <span class="mr-4">📍 ${job.location}</span>
                    </div>
                    
                    <div class="flex flex-wrap gap-2">
                        ${(job.skills || []).map(skill => `
                            <span class="px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-full">${skill}</span>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Load insights on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Protect page - redirect to login if not authenticated
            if (!protectPage()) {
                return;
            }
            loadInsights();
        });
    </script>

    <!-- Overlay for mobile -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-40 hidden" onclick="toggleSidebar()"></div>
</body>
</html>
