<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achievements & Rankings - DelphiMinds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .badge-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .badge-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .earned-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
        }
        .bronze-badge { border-left: 4px solid #cd7f32; }
        .silver-badge { border-left: 4px solid #c0c0c0; }
        .gold-badge { border-left: 4px solid #ffd700; }
        .platinum-badge { border-left: 4px solid #e5e7eb; }
    </style>
</head>
<body class="bg-blue-50">
    <nav class="bg-blue-900 shadow-sm border-b border-blue-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-white hover:text-cyan-200 transition-colors">
                        DelphiMinds
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-gray-200 hover:text-white">Dashboard</a>
                    <a href="insights.html" class="text-gray-200 hover:text-white">Insights</a>
                    <a href="community.html" class="text-gray-200 hover:text-white">Community</a>
                    <a href="roadmap.html" class="text-gray-200 hover:text-white">Roadmap</a>
                    <a href="resume.html" class="text-gray-200 hover:text-white">Resume</a>
                    <a href="psychometric.html" class="text-gray-200 hover:text-white">Test</a>
                    <a href="chat.html" class="text-gray-200 hover:text-white">Chat</a>
                    <a href="gamification.html" class="text-cyan-200 font-medium">Achievements</a>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Achievements & Rankings</h1>
            <p class="mt-2 text-gray-600">Track your progress, earn badges, and climb the leaderboard</p>
        </div>

        <!-- User Profile & Progress Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1">
                    <div class="text-center">
                        <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-white text-2xl font-bold" id="userLevel">1</span>
                        </div>
                        <h3 class="text-lg font-semibold" id="userName">User</h3>
                        <p class="text-gray-600" id="userTitle">Beginner</p>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="badgesEarned">0</div>
                            <div class="text-sm text-gray-600">Badges Earned</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600" id="currentStreak">0</div>
                            <div class="text-sm text-gray-600">Current Streak</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="totalPoints">0</div>
                            <div class="text-sm text-gray-600">Total Points</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600" id="userRank">#-</div>
                            <div class="text-sm text-gray-600">Your Rank</div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Level Progress</span>
                            <span id="levelProgress">0/100 XP</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all" id="levelProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Manage Your Achievements</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="showAddCertificationModal()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-certificate mr-2"></i>Add Certification
                </button>
                <button onclick="showAddAchievementModal()" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-trophy mr-2"></i>Add Achievement
                </button>
                <button onclick="updateStreaks()" class="bg-purple-600 text-white px-4 py-3 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-fire mr-2"></i>Update Streaks
                </button>
            </div>
        </div>

        <!-- Badge Categories Filter -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Filter Badges</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="filterBadges('all')" class="filter-btn active bg-blue-600 text-white px-4 py-2 rounded-lg" data-category="all">
                    All Badges
                </button>
                <button onclick="filterBadges('skill')" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300" data-category="skill">
                    <i class="fas fa-code mr-2"></i>Skill Category
                </button>
                <button onclick="filterBadges('roadmap')" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300" data-category="roadmap">
                    <i class="fas fa-map mr-2"></i>Roadmap Stage
                </button>
                <button onclick="filterBadges('achievement')" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300" data-category="achievement">
                    <i class="fas fa-trophy mr-2"></i>Achievement Type
                </button>
                <button onclick="filterBadges('streak')" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300" data-category="streak">
                    <i class="fas fa-fire mr-2"></i>Streaks
                </button>
                <button onclick="filterBadges('community')" class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300" data-category="community">
                    <i class="fas fa-users mr-2"></i>Community
                </button>
            </div>
        </div>

        <!-- Badges Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- My Badges -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">My Badges</h2>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm" id="myBadgeCount">0 earned</span>
                </div>
                <div id="myBadges" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- My badges will be loaded here -->
                </div>
            </div>

            <!-- Available Badges -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Available Badges</h2>
                    <span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm" id="availableBadgeCount">0 available</span>
                </div>
                <div id="availableBadges" class="space-y-4 max-h-96 overflow-y-auto">
                    <!-- Available badges will be loaded here -->
                </div>
            </div>
        </div>

        <!-- User Certifications & Achievements -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Certifications -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">My Certifications</h2>
                    <button onclick="showAddCertificationModal()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                        <i class="fas fa-plus mr-1"></i>Add
                    </button>
                </div>
                <div id="userCertifications" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- User certifications will be loaded here -->
                </div>
            </div>

            <!-- Recent Achievements -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Recent Achievements</h2>
                <div id="recentAchievements" class="space-y-3 max-h-80 overflow-y-auto">
                    <!-- Recent achievements will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Leaderboard</h2>
                <select id="leaderboardType" onchange="loadLeaderboard()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <option value="overall">Overall Points</option>
                    <option value="monthly">This Month</option>
                    <option value="tests">Test Scores</option>
                    <option value="streaks">Longest Streaks</option>
                </select>
            </div>
            <div id="leaderboard" class="space-y-3">
                <!-- Leaderboard will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Add Certification Modal -->
    <div id="certificationModal" class="modal fixed inset-0 z-50 hidden">
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Add Certification</h3>
                    <button onclick="closeModal('certificationModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="certificationForm" onsubmit="submitCertification(event)" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Certification Title *</label>
                        <input type="text" name="title" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., AWS Certified Solutions Architect">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Issuing Organization *</label>
                        <input type="text" name="issuer" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="e.g., Amazon Web Services">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Issue Date *</label>
                            <input type="date" name="issue_date" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                            <input type="date" name="expiry_date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Credential ID</label>
                        <input type="text" name="credential_id" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Certificate/Badge ID">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Verification URL</label>
                        <input type="url" name="verification_url" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="https://...">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Upload Certificate</label>
                        <input type="file" name="certificate_file" accept=".pdf,.jpg,.jpeg,.png" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Supported formats: PDF, JPG, PNG (Max 5MB)</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Brief description of the certification and skills gained..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('certificationModal')" 
                                class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Add Certification
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Achievement Modal -->
    <div id="achievementModal" class="modal fixed inset-0 z-50 hidden">
        <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Add Achievement</h3>
                    <button onclick="closeModal('achievementModal')" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="achievementForm" onsubmit="submitAchievement(event)" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Achievement Type *</label>
                        <select name="achievement_type" onchange="updateAchievementFields()" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Achievement Type</option>
                            <option value="competition">Competitions & Hackathons</option>
                            <option value="project">Projects</option>
                            <option value="internship">Internships / Work Experience</option>
                            <option value="workshop">Workshops / Training</option>
                            <option value="publication">Publications / Research</option>
                        </select>
                    </div>
                    
                    <!-- Dynamic Fields Container -->
                    <div id="dynamicFields">
                        <!-- Fields will be populated based on achievement type -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea name="description" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Provide additional details about your achievement..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="closeModal('achievementModal')" 
                                class="px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            Add Achievement
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        async function loadGamificationData() {
            try {
                const token = localStorage.getItem('access_token');
                
                // Load my badges
                const myBadgesResponse = await fetch('/gamification/my-badges/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (myBadgesResponse.ok) {
                    const myBadges = await myBadgesResponse.json();
                    updateMyBadges(myBadges);
                    document.getElementById('badgesEarned').textContent = myBadges.length;
                }

                // Load all badges
                const allBadgesResponse = await fetch('/gamification/badges/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (allBadgesResponse.ok) {
                    const allBadges = await allBadgesResponse.json();
                    updateAvailableBadges(allBadges);
                }

                // Load streak
                const streakResponse = await fetch('/gamification/streak/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (streakResponse.ok) {
                    const streak = await streakResponse.json();
                    document.getElementById('currentStreak').textContent = streak.current_streak || 0;
                }

                // Load leaderboard
                const leaderboardResponse = await fetch('/gamification/leaderboard/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (leaderboardResponse.ok) {
                    const leaderboard = await leaderboardResponse.json();
                    updateLeaderboard(leaderboard);
                }

                // Load achievements
                const achievementsResponse = await fetch('/gamification/achievements/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (achievementsResponse.ok) {
                    const achievements = await achievementsResponse.json();
                    updateAchievementsHistory(achievements);
                    updateRecentAchievements(achievements);
                }

                // Load user profile data
                const profileResponse = await fetch('/accounts/profile/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (profileResponse.ok) {
                    const profile = await profileResponse.json();
                    document.getElementById('totalPoints').textContent = profile.total_points || 0;
                    document.getElementById('userLevel').textContent = calculateLevel(profile.total_points || 0);
                }

            } catch (error) {
                console.error('Error loading gamification data:', error);
            }
        }

        function updateMyBadges(badges) {
            const container = document.getElementById('myBadges');
            
            if (badges.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No badges earned yet. Keep learning to unlock your first badge!</p>';
                return;
            }

            container.innerHTML = badges.map(badge => `
                <div class="flex items-center p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div class="text-2xl mr-3">${badge.badge.icon}</div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-green-800">${badge.badge.name}</h3>
                        <p class="text-sm text-green-600">${badge.badge.description}</p>
                        <p class="text-xs text-green-500 mt-1">Earned on ${new Date(badge.earned_at).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateAvailableBadges(badges) {
            const container = document.getElementById('availableBadges');
            
            if (badges.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No badges available.</p>';
                return;
            }

            container.innerHTML = badges.map(badge => `
                <div class="flex items-center p-3 bg-gray-50 border border-gray-200 rounded-lg" data-category="${badge.badge_type}">
                    <div class="text-2xl mr-3">${badge.icon}</div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800">${badge.name}</h3>
                        <p class="text-sm text-gray-600">${badge.description}</p>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs px-2 py-1 bg-${getDifficultyColor(badge.difficulty)}-100 text-${getDifficultyColor(badge.difficulty)}-800 rounded-full">
                                ${badge.difficulty.toUpperCase()}
                            </span>
                            <span class="text-xs text-gray-500">${badge.points_required} points</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getDifficultyColor(difficulty) {
            const colors = {
                'bronze': 'orange',
                'silver': 'gray',
                'gold': 'yellow',
                'platinum': 'purple'
            };
            return colors[difficulty] || 'blue';
        }

        function calculateLevel(points) {
            if (points < 100) return 'Beginner';
            if (points < 500) return 'Intermediate';
            if (points < 1000) return 'Advanced';
            if (points < 2000) return 'Expert';
            return 'Master';
        }

        function updateLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboard');
            
            if (leaderboard.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No leaderboard data available.</p>';
                return;
            }

            container.innerHTML = leaderboard.map((entry, index) => `
                <div class="flex items-center justify-between p-3 ${index < 3 ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50 border border-gray-200'} rounded-lg">
                    <div class="flex items-center">
                        <div class="w-8 h-8 ${index < 3 ? 'bg-yellow-100' : 'bg-gray-100'} rounded-full flex items-center justify-center mr-3">
                            <span class="text-sm font-semibold ${index < 3 ? 'text-yellow-600' : 'text-gray-600'}">${index + 1}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold">${entry.username}</h3>
                            <p class="text-sm text-gray-600">${entry.total_points} points</p>
                        </div>
                    </div>
                    ${index < 3 ? '<span class="text-yellow-600">🏆</span>' : ''}
                </div>
            `).join('');
        }

        function updateAchievementsHistory(achievements) {
            const container = document.getElementById('achievementsHistory');
            
            if (achievements.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No achievements yet.</p>';
                return;
            }

            container.innerHTML = achievements.map(achievement => `
                <div class="flex items-center p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="text-2xl mr-3">🏅</div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-blue-800">${achievement.title}</h3>
                        <p class="text-sm text-blue-600">${achievement.description}</p>
                        <p class="text-xs text-blue-500 mt-1">+${achievement.points_earned} points • ${new Date(achievement.achieved_at).toLocaleDateString()}</p>
                    </div>
                </div>
            `).join('');
        }

        // Modal management functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function showAddCertificationModal() {
            openModal('certificationModal');
        }
        
        function showAddAchievementModal() {
            openModal('achievementModal');
        }
        
        // Dynamic achievement fields based on type
        function updateAchievementFields() {
            const achievementType = document.querySelector('[name="achievement_type"]').value;
            const dynamicFields = document.getElementById('dynamicFields');
            
            let fieldsHTML = '';
            
            switch(achievementType) {
                case 'competition':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Event Name *</label>
                            <input type="text" name="event_name" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Smart India Hackathon 2025">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Role/Team *</label>
                                <input type="text" name="role" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="e.g., Team Leader">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rank/Position *</label>
                                <input type="text" name="rank" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="e.g., Winner, 1st Place">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date *</label>
                            <input type="date" name="achievement_date" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    `;
                    break;
                    
                case 'project':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project Title *</label>
                            <input type="text" name="project_title" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., AI-Powered Resume Analyzer">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">GitHub/Portfolio Link</label>
                            <input type="url" name="project_link" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="https://github.com/username/project">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="date" name="start_date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" name="end_date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Technologies Used</label>
                            <input type="text" name="technologies" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Python, Django, React, PostgreSQL">
                        </div>
                    `;
                    break;
                    
                case 'internship':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Role *</label>
                            <input type="text" name="role" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Data Analyst Intern">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Company *</label>
                            <input type="text" name="company" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Infosys">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date *</label>
                                <input type="date" name="start_date" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="date" name="end_date" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Key Achievement</label>
                            <input type="text" name="key_achievement" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Improved data processing efficiency by 30%">
                        </div>
                    `;
                    break;
                    
                case 'workshop':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Workshop Title *</label>
                            <input type="text" name="workshop_title" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Microsoft AI Bootcamp">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Provider/Organization *</label>
                            <input type="text" name="provider" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Microsoft">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Completion Date *</label>
                                <input type="date" name="completion_date" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration (hours)</label>
                                <input type="number" name="duration" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="40">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Certificate URL</label>
                            <input type="url" name="certificate_url" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="https://...">
                        </div>
                    `;
                    break;
                    
                case 'publication':
                    fieldsHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Publication Title *</label>
                            <input type="text" name="publication_title" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Machine Learning Approaches to Recommender Systems">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Journal/Conference *</label>
                            <input type="text" name="journal" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., IEEE Transactions on Neural Networks">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Publication Date *</label>
                                <input type="date" name="publication_date" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">DOI</label>
                                <input type="text" name="doi" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="10.1109/TNNLS.2023.1234567">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Publication Link</label>
                            <input type="url" name="publication_link" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="https://...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Authors</label>
                            <input type="text" name="authors" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., John Doe, Jane Smith">
                        </div>
                    `;
                    break;
                    
                default:
                    fieldsHTML = '<p class="text-sm text-gray-500">Please select an achievement type to continue.</p>';
            }
            
            dynamicFields.innerHTML = fieldsHTML;
        }

        // Badge filtering functions
        function filterBadges(category) {
            const badges = document.querySelectorAll('#availableBadges > div');
            badges.forEach(badge => {
                if (category === 'all' || badge.dataset.category === category) {
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            });

            // Update active filter button
            document.querySelectorAll('[onclick^="filterBadges"]').forEach(btn => {
                btn.classList.remove('bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-700');
            event.target.classList.add('bg-blue-500', 'text-white');
        }

        // Form submission handlers
        async function submitCertification(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch('/gamification/certifications/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    closeModal('certificationModal');
                    form.reset();
                    loadGamificationData(); // Refresh data
                    showNotification('Certification added successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Error adding certification', 'error');
                }
            } catch (error) {
                console.error('Error submitting certification:', error);
                showNotification('Error adding certification', 'error');
            }
        }

        async function submitAchievement(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const token = localStorage.getItem('access_token');
            
            // Collect all form data into a structured object
            const achievementData = {
                achievement_type: formData.get('achievement_type'),
                description: formData.get('description'),
            };
            
            // Add type-specific fields
            const achievementType = formData.get('achievement_type');
            switch(achievementType) {
                case 'competition':
                    achievementData.title = `${formData.get('rank')} at ${formData.get('event_name')}`;
                    achievementData.event_name = formData.get('event_name');
                    achievementData.role = formData.get('role');
                    achievementData.rank = formData.get('rank');
                    achievementData.achievement_date = formData.get('achievement_date');
                    break;
                case 'project':
                    achievementData.title = `Built ${formData.get('project_title')}`;
                    achievementData.project_title = formData.get('project_title');
                    achievementData.project_link = formData.get('project_link');
                    achievementData.technologies = formData.get('technologies');
                    achievementData.start_date = formData.get('start_date');
                    achievementData.end_date = formData.get('end_date');
                    break;
                case 'internship':
                    achievementData.title = `${formData.get('role')} at ${formData.get('company')}`;
                    achievementData.role = formData.get('role');
                    achievementData.company = formData.get('company');
                    achievementData.start_date = formData.get('start_date');
                    achievementData.end_date = formData.get('end_date');
                    achievementData.key_achievement = formData.get('key_achievement');
                    break;
                case 'workshop':
                    achievementData.title = `Completed ${formData.get('workshop_title')}`;
                    achievementData.workshop_title = formData.get('workshop_title');
                    achievementData.provider = formData.get('provider');
                    achievementData.completion_date = formData.get('completion_date');
                    achievementData.duration = formData.get('duration');
                    achievementData.certificate_url = formData.get('certificate_url');
                    break;
                case 'publication':
                    achievementData.title = `Published "${formData.get('publication_title')}"`;
                    achievementData.publication_title = formData.get('publication_title');
                    achievementData.journal = formData.get('journal');
                    achievementData.publication_date = formData.get('publication_date');
                    achievementData.doi = formData.get('doi');
                    achievementData.publication_link = formData.get('publication_link');
                    achievementData.authors = formData.get('authors');
                    break;
            }
            
            // Calculate points based on achievement type
            achievementData.points_earned = calculateAchievementPoints(achievementType);

            try {
                const response = await fetch('/gamification/achievements/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(achievementData)
                });

                if (response.ok) {
                    const result = await response.json();
                    closeModal('achievementModal');
                    form.reset();
                    document.getElementById('dynamicFields').innerHTML = '';
                    loadGamificationData(); // Refresh data
                    showNotification('Achievement added successfully!', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Error adding achievement', 'error');
                }
            } catch (error) {
                console.error('Error submitting achievement:', error);
                showNotification('Error adding achievement', 'error');
            }
        }
        
        function calculateAchievementPoints(achievementType) {
            const pointsMap = {
                'competition': 100,
                'project': 80,
                'internship': 120,
                'workshop': 60,
                'publication': 150
            };
            return pointsMap[achievementType] || 50;
        }

        // Leaderboard management
        async function loadLeaderboard() {
            const type = document.getElementById('leaderboardType').value;
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`/gamification/leaderboard/?type=${type}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const leaderboard = await response.json();
                    updateLeaderboard(leaderboard);
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Update recent achievements
        function updateRecentAchievements(achievements) {
            const container = document.getElementById('recentAchievements');
            const recent = achievements.slice(0, 5); // Show only last 5
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No recent achievements.</p>';
                return;
            }

            container.innerHTML = recent.map(achievement => `
                <div class="flex items-center p-2 bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-400 rounded">
                    <div class="text-lg mr-3">🎉</div>
                    <div class="flex-1">
                        <h4 class="font-medium text-purple-800">${achievement.title}</h4>
                        <p class="text-xs text-purple-600">${new Date(achievement.achieved_at).toLocaleDateString()}</p>
                    </div>
                    <span class="text-sm font-semibold text-purple-600">+${achievement.points_earned}</span>
                </div>
            `).join('');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadGamificationData();
            
            // Set up modal close handlers
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-overlay')) {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                }
            });
            
            // Handle escape key for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal:not(.hidden)').forEach(modal => {
                        modal.classList.add('hidden');
                    });
                }
            });
        });
    </script>
</body>
</html>
