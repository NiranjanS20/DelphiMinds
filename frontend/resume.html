<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Analyzer - DelphiMinds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-blue-50">
    <nav class="bg-blue-900 shadow-sm border-b border-blue-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-white hover:text-cyan-200 transition-colors">
                        DelphiMinds
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-gray-700 hover:text-gray-900">Dashboard</a>
                    <a href="insights.html" class="text-gray-700 hover:text-gray-900">Insights</a>
                    <a href="community.html" class="text-gray-700 hover:text-gray-900">Community</a>
                    <a href="roadmap.html" class="text-gray-700 hover:text-gray-900">Roadmap</a>
                    <a href="resume.html" class="text-blue-600 font-medium">Resume</a>
                    <a href="resume-analysis.html" class="text-gray-700 hover:text-gray-900">Advanced Analysis</a>
                    <a href="chat.html" class="text-gray-700 hover:text-gray-900">Chat</a>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Resume Analyzer</h1>
            <p class="mt-2 text-gray-600">Upload your resume for AI-powered analysis and improvement suggestions</p>
            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-1"></i>
                    Want more detailed insights? Try our <a href="resume-analysis.html" class="text-blue-600 hover:text-blue-800 underline">Advanced Resume Analysis</a> with AI-powered keywords extraction, sentiment analysis, and personalized improvement roadmaps.
                </p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Upload Resume</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Resume Title</label>
                    <input type="text" id="resumeTitle" placeholder="e.g., Software Engineer Resume" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select File</label>
                    <input type="file" id="resumeFile" accept=".pdf,.doc,.docx" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Upload & Analyze
                </button>
            </form>
        </div>

        <!-- Resume List -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Your Resumes</h2>
            <div id="resumeList">
                <!-- Resumes will be loaded here -->
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysisSection" class="hidden">
            <!-- Overall Score -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Overall Score</h2>
                <div class="flex items-center justify-center">
                    <div class="relative w-32 h-32">
                        <canvas id="scoreChart"></canvas>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="scoreValue" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Keyword Matches -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Keyword Analysis</h2>
                <div id="keywordMatches">
                    <!-- Keyword matches will be displayed here -->
                </div>
            </div>

            <!-- Missing Skills -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Missing Skills</h2>
                <div id="missingSkills">
                    <!-- Missing skills will be displayed here -->
                </div>
            </div>

            <!-- Suggestions -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Improvement Suggestions</h2>
                <div id="suggestions">
                    <!-- Suggestions will be displayed here -->
                </div>
            </div>

            <!-- Job Matches -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold mb-4">Job Matches</h2>
                <div id="jobMatches">
                    <!-- Job matches will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let scoreChart;

        async function loadResumes() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/resume/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load resumes');
                }

                const resumes = await response.json();
                updateResumeList(resumes);
            } catch (error) {
                console.error('Error loading resumes:', error);
                showError('Failed to load resumes');
            }
        }

        function updateResumeList(resumes) {
            const container = document.getElementById('resumeList');
            
            if (resumes.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No resumes uploaded yet.</p>';
                return;
            }

            container.innerHTML = resumes.map(resume => `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">${resume.title}</h3>
                            <p class="text-sm text-gray-500">Uploaded: ${new Date(resume.uploaded_at).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            ${resume.analysis_completed ? 
                                `<button onclick="viewAnalysis(${resume.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    View Analysis
                                </button>` :
                                `<button onclick="analyzeResume(${resume.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    Analyze
                                </button>`
                            }
                            <button onclick="deleteResume(${resume.id})" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function analyzeResume(resumeId) {
            try {
                const token = localStorage.getItem('access_token');
                // Since the enhanced analyze endpoint requires a file upload,
                // we'll show a message that analysis was already done during upload
                showError('Analysis is performed automatically during upload. Please upload a new resume to get fresh analysis.');
            } catch (error) {
                console.error('Error analyzing resume:', error);
                showError('Failed to analyze resume');
            }
        }

        async function viewAnalysis(resumeId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/resume/${resumeId}/analysis/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load analysis');
                }

                const data = await response.json();
                displayAnalysis(data.analysis, data.job_matches);
            } catch (error) {
                console.error('Error loading analysis:', error);
                showError('Failed to load analysis. This resume may need to be re-analyzed.');
            }
        }

        function displayAnalysis(analysis, jobMatches = []) {
            // Show analysis section
            document.getElementById('analysisSection').classList.remove('hidden');
            
            // Update overall score
            const overallScore = Math.round(analysis.overall_score || 0);
            document.getElementById('scoreValue').textContent = overallScore;
            updateScoreChart(overallScore);
            
            // Update keyword matches - handle both old and new format
            const keywordMatches = analysis.keyword_matches || {};
            if (analysis.skills && analysis.skills.length > 0) {
                // Convert skills to keyword matches format
                analysis.skills.slice(0, 10).forEach(skill => {
                    keywordMatches[skill.skill] = skill.confidence;
                });
            }
            updateKeywordMatches(keywordMatches);
            
            // Update missing skills
            updateMissingSkills(analysis.missing_skills || []);
            
            // Update suggestions - handle multiple suggestion sources
            const allSuggestions = [];
            if (analysis.suggestions) allSuggestions.push(...analysis.suggestions);
            if (analysis.suggested_changes) allSuggestions.push(...analysis.suggested_changes);
            if (analysis.improvement_suggestions) allSuggestions.push(...analysis.improvement_suggestions);
            updateSuggestions(allSuggestions);
            
            // Update job matches
            updateJobMatches(jobMatches);
            
            // Scroll to results
            document.getElementById('analysisSection').scrollIntoView({ behavior: 'smooth' });
        }

        function updateScoreChart(score) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            scoreChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [score, 100 - score],
                        backgroundColor: ['#3B82F6', '#E5E7EB'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateKeywordMatches(keywordMatches) {
            const container = document.getElementById('keywordMatches');
            
            if (Object.keys(keywordMatches).length === 0) {
                container.innerHTML = '<p class="text-gray-500">No keyword analysis available.</p>';
                return;
            }

            container.innerHTML = Object.entries(keywordMatches).map(([keyword, score]) => `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-medium">${keyword}</span>
                    <div class="flex items-center">
                        <div class="w-32 bg-gray-200 rounded-full h-2 mr-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${score * 100}%"></div>
                        </div>
                        <span class="text-sm text-gray-600">${Math.round(score * 100)}%</span>
                    </div>
                </div>
            `).join('');
        }

        function updateMissingSkills(missingSkills) {
            const container = document.getElementById('missingSkills');
            
            if (missingSkills.length === 0) {
                container.innerHTML = '<p class="text-green-600">Great! No major skills are missing.</p>';
                return;
            }

            container.innerHTML = missingSkills.map(skill => `
                <div class="bg-red-50 border border-red-200 rounded p-3 mb-2">
                    <span class="text-red-800">${skill}</span>
                </div>
            `).join('');
        }

        function updateSuggestions(suggestions) {
            const container = document.getElementById('suggestions');
            
            if (suggestions.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No suggestions available.</p>';
                return;
            }

            container.innerHTML = suggestions.map(suggestion => `
                <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                    <span class="text-blue-800">${suggestion}</span>
                </div>
            `).join('');
        }

        function updateJobMatches(jobMatches) {
            const container = document.getElementById('jobMatches');
            
            if (jobMatches.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No job matches available.</p>';
                return;
            }

            container.innerHTML = jobMatches.map(job => `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-lg">${job.job_title}</h3>
                        <span class="text-blue-600 font-bold">${job.match_percentage}% match</span>
                    </div>
                    <div class="mb-3">
                        <h4 class="font-medium text-sm text-gray-700 mb-1">Missing Requirements:</h4>
                        <div class="flex flex-wrap gap-1">
                            ${job.missing_requirements.map(req => `
                                <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">${req}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <h4 class="font-medium text-sm text-gray-700 mb-1">Recommendations:</h4>
                        <ul class="text-sm text-gray-600">
                            ${job.recommendations.map(rec => `<li>â€¢ ${rec}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `).join('');
        }

        async function deleteResume(resumeId) {
            if (!confirm('Are you sure you want to delete this resume?')) {
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/resume/${resumeId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    loadResumes();
                } else {
                    throw new Error('Failed to delete resume');
                }
            } catch (error) {
                console.error('Error deleting resume:', error);
                showError('Failed to delete resume');
            }
        }

        // Handle file upload and immediate analysis
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('resumeTitle').value;
            const file = document.getElementById('resumeFile').files[0];
            
            if (!title || !file) {
                showError('Please fill in all fields and select a file');
                return;
            }
            
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    showError('Please log in to upload and analyze resumes');
                    return;
                }

                // Show loading state
                const submitButton = e.target.querySelector('button[type="submit"]');
                const originalText = submitButton.textContent;
                submitButton.textContent = 'Analyzing...';
                submitButton.disabled = true;
                
                const formData = new FormData();
                formData.append('title', title);
                formData.append('resume_file', file);  // Use resume_file as expected by the API
                
                // Call the enhanced analyze endpoint directly
                const response = await fetch('/resume/analyze/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    // Clear form
                    document.getElementById('resumeTitle').value = '';
                    document.getElementById('resumeFile').value = '';
                    
                    // Display analysis results
                    displayAnalysis(result.analysis);
                    
                    // Reload resumes list
                    loadResumes();
                    
                    showSuccess('Resume uploaded and analyzed successfully!');
                } else {
                    const error = await response.json();
                    showError(error.error || error.detail || 'Failed to upload and analyze resume');
                }
                
                // Reset button
                submitButton.textContent = originalText;
                submitButton.disabled = false;
                
            } catch (error) {
                console.error('Error uploading resume:', error);
                showError('Failed to upload resume. Please check your connection and try again.');
                
                // Reset button
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.textContent = 'Upload & Analyze';
                submitButton.disabled = false;
            }
        });

        // Load resumes on page load
        document.addEventListener('DOMContentLoaded', loadResumes);

        // Utility functions for notifications
        function showError(message) {
            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showSuccess(message) {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-green-500 hover:text-green-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>
