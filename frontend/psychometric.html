<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Assessment Hub - DelphiMinds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .difficulty-bronze { border-left: 4px solid #cd7f32; }
        .difficulty-silver { border-left: 4px solid #c0c0c0; }
        .difficulty-gold { border-left: 4px solid #ffd700; }
        .difficulty-hard { border-left: 4px solid #dc2626; }
    </style>
</head>
<body class="bg-blue-50">
    <nav class="bg-blue-900 shadow-sm border-b border-blue-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-white hover:text-cyan-200 transition-colors">
                        DelphiMinds
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-gray-200 hover:text-white">Dashboard</a>
                    <a href="insights.html" class="text-gray-200 hover:text-white">Insights</a>
                    <a href="community.html" class="text-gray-200 hover:text-white">Community</a>
                    <a href="roadmap.html" class="text-gray-200 hover:text-white">Roadmap</a>
                    <a href="resume.html" class="text-gray-200 hover:text-white">Resume</a>
                    <a href="psychometric.html" class="text-cyan-200 font-medium">Test</a>
                    <a href="chat.html" class="text-gray-200 hover:text-white">Chat</a>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Career Assessment Hub</h1>
            <p class="mt-2 text-gray-600">Comprehensive assessments to discover your strengths, personality, and ideal career paths</p>
        </div>

        <!-- User Progress Overview -->
        <div class="bg-white rounded-lg shadow p-6 mb-6" id="progressOverview">
            <h2 class="text-xl font-semibold mb-4">Your Progress</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="userStats">
                <!-- User statistics will be loaded here -->
            </div>
        </div>

        <!-- Test Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Filter Tests</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <select id="categoryFilter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="">All Categories</option>
                    <option value="psychometric">Psychometric Test</option>
                    <option value="skills">Skills Assessment</option>
                    <option value="aptitude">Aptitude Test</option>
                    <option value="interests">Career Interest Test</option>
                    <option value="custom">DelphiMinds Custom</option>
                </select>
                <select id="difficultyFilter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="">All Difficulties</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
                <select id="sortFilter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="featured">Recommended</option>
                    <option value="popular">Most Popular</option>
                    <option value="newest">Newest</option>
                    <option value="shortest">Shortest</option>
                </select>
                <input type="text" id="searchFilter" placeholder="Search tests..." 
                       class="border border-gray-300 rounded-md px-3 py-2">
            </div>
        </div>

        <!-- Available Tests Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6" id="testSelection">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Available Tests</h2>
                <div class="text-sm text-gray-500" id="testCount">Loading tests...</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="availableTests">
                <!-- Available tests will be loaded here -->
            </div>
        </div>

        <!-- Test Interface -->
        <div id="testInterface" class="hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-semibold" id="testTitle">Test Title</h2>
                        <p class="text-gray-600" id="testInstructions">Test instructions will appear here</p>
                    </div>
                    <div class="text-sm text-gray-500">
                        Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-sm text-gray-500">
                        <span>Progress</span>
                        <span id="progressPercent">0%</span>
                    </div>
                </div>

                <div id="questionContainer" class="mb-6">
                    <!-- Questions will be loaded here -->
                </div>

                <div class="flex justify-between">
                    <button id="prevButton" onclick="previousQuestion()" 
                            class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 disabled:opacity-50" disabled>
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button id="nextButton" onclick="nextQuestion()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700">
                        Next<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" class="hidden">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Your Assessment Results</h2>
                    <button onclick="downloadReport()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        <i class="fas fa-download mr-2"></i>Download Report
                    </button>
                </div>
                
                <!-- Summary Dashboard -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Overall Score</h3>
                        <div class="text-3xl font-bold" id="overallScore">0%</div>
                        <p class="text-blue-100" id="scoreInterpretation">-</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Percentile Rank</h3>
                        <div class="text-3xl font-bold" id="percentileRank">0%</div>
                        <p class="text-green-100">Better than others</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <h3 class="text-lg font-semibold mb-2">Badge Earned</h3>
                        <div class="text-2xl font-bold" id="badgeEarned">-</div>
                        <p class="text-purple-100">Achievement unlocked</p>
                    </div>
                </div>
                
                <div id="resultsContent">
                    <!-- Detailed results will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Previous Tests Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">Previous Tests</h2>
            <div id="previousTests">
                <!-- Previous test results will be loaded here -->
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let currentTest = null;
        let currentResponse = null;
        let currentQuestionIndex = 0;
        let answers = {};

        async function loadAvailableTests() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/psychometric/tests/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load tests');
                }

                const tests = await response.json();
                updateAvailableTests(tests);
                updateTestCount(tests.length);
                loadUserStats();
            } catch (error) {
                console.error('Error loading tests:', error);
                showError('Failed to load available tests');
            }
        }

        function updateTestCount(count) {
            document.getElementById('testCount').textContent = `${count} tests available`;
        }

        async function loadUserStats() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/psychometric/user-stats/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    updateUserStats(stats);
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        function updateUserStats(stats) {
            const container = document.getElementById('userStats');
            container.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600">${stats.tests_completed || 0}</div>
                    <div class="text-sm text-gray-600">Tests Completed</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600">${stats.average_score || 0}%</div>
                    <div class="text-sm text-gray-600">Average Score</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-purple-600">${stats.badges_earned || 0}</div>
                    <div class="text-sm text-gray-600">Badges Earned</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                    <div class="text-2xl font-bold text-yellow-600">${stats.current_streak || 0}</div>
                    <div class="text-sm text-gray-600">Day Streak</div>
                </div>
            `;
        }

        function updateAvailableTests(tests) {
            const container = document.getElementById('availableTests');
            
            if (tests.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No tests available at the moment.</p>';
                return;
            }

            container.innerHTML = tests.map(test => {
                const difficultyClass = getDifficultyClass(test.difficulty);
                const categoryIcon = getCategoryIcon(test.category);
                const estimatedTime = test.estimated_time || 15;
                
                return `
                    <div class="test-card bg-white border border-gray-200 rounded-lg p-6 cursor-pointer hover:shadow-lg transition-all duration-200 ${difficultyClass}" 
                         onclick="startTest(${test.id})" data-category="${test.category}" data-difficulty="${test.difficulty}">
                        <div class="flex items-start justify-between mb-4">
                            <div class="text-3xl">${categoryIcon}</div>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                test.difficulty === 'easy' ? 'bg-green-100 text-green-800' :
                                test.difficulty === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${test.difficulty.toUpperCase()}
                            </span>
                        </div>
                        
                        <h3 class="font-bold text-lg text-gray-900 mb-2">${test.name}</h3>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-3">${test.description}</p>
                        
                        <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-clock mr-1"></i>
                                <span>${estimatedTime} mins</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-question-circle mr-1"></i>
                                <span>${test.question_count || test.questions?.length || 'N/A'} questions</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-100 text-blue-800">
                                ${getCategoryName(test.category)}
                            </span>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors">
                                Start Test
                            </button>
                        </div>
                        
                        ${test.max_attempts && test.attempts_taken ? `
                            <div class="mt-3 text-xs text-gray-500">
                                Attempts: ${test.attempts_taken}/${test.max_attempts}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function getDifficultyClass(difficulty) {
            const classes = {
                'easy': 'difficulty-bronze',
                'medium': 'difficulty-silver', 
                'hard': 'difficulty-gold'
            };
            return classes[difficulty] || 'difficulty-bronze';
        }

        function getCategoryIcon(category) {
            const icons = {
                'psychometric': 'üß†',
                'skills': 'üíª',
                'aptitude': 'üéØ',
                'interests': 'üåü',
                'custom': 'üöÄ'
            };
            return icons[category] || 'üìù';
        }

        function getCategoryName(category) {
            const names = {
                'psychometric': 'Personality',
                'skills': 'Skills',
                'aptitude': 'Aptitude',
                'interests': 'Career Interest',
                'custom': 'DelphiMinds'
            };
            return names[category] || category;
        }

        async function startTest(testId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/psychometric/start/${testId}/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to start test');
                }

                const testResponse = await response.json();
                currentResponse = testResponse;
                currentTest = testResponse.test;
                currentQuestionIndex = 0;
                answers = {};

                // Hide test selection, show test interface
                document.getElementById('testSelection').classList.add('hidden');
                document.getElementById('testInterface').classList.remove('hidden');
                document.getElementById('testResults').classList.add('hidden');

                loadQuestion();
            } catch (error) {
                console.error('Error starting test:', error);
                showError('Failed to start test');
            }
        }

        function loadQuestion() {
            if (!currentTest || !currentTest.questions) {
                showError('Test data not available');
                return;
            }

            const question = currentTest.questions[currentQuestionIndex];
            if (!question) {
                showError('Question not found');
                return;
            }

            // Update progress
            document.getElementById('testTitle').textContent = currentTest.name;
            document.getElementById('testInstructions').textContent = 
                `Question ${currentQuestionIndex + 1}: ${question.instruction || 'Select the best answer'}`;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = currentTest.questions.length;
            
            const progress = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;

            // Update navigation buttons
            document.getElementById('prevButton').disabled = currentQuestionIndex === 0;
            const nextButton = document.getElementById('nextButton');
            if (currentQuestionIndex === currentTest.questions.length - 1) {
                nextButton.innerHTML = '<i class="fas fa-check mr-2"></i>Finish Test';
                nextButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                nextButton.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                nextButton.innerHTML = 'Next<i class="fas fa-arrow-right ml-2"></i>';
                nextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                nextButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }

            // Display question
            const container = document.getElementById('questionContainer');
            container.innerHTML = `
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <div class="flex items-center mb-4">
                        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold mr-3">
                            ${getCategoryName(currentTest.category)}
                        </span>
                        <span class="text-sm text-gray-500">
                            ${question.question_type.replace('_', ' ').toUpperCase()}
                        </span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-900 mb-6">${question.text}</h3>
                    <div class="space-y-3">
                        ${renderQuestionOptions(question)}
                    </div>
                </div>
            `;
            
            // Add change listeners for answers
            addAnswerListeners(question);
        }
        
        function addAnswerListeners(question) {
            const inputs = document.querySelectorAll(`[name="question_${question.id}"]`);
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.type === 'radio') {
                        answers[question.id] = this.value;
                    } else {
                        answers[question.id] = this.value;
                    }
                });
            });
        }

        function renderQuestionOptions(question) {
            if (question.question_type === 'multiple_choice' && question.options) {
                return question.options.map((option, index) => {
                    const letter = String.fromCharCode(65 + index);
                    return `
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition-all duration-200 group">
                            <input type="radio" name="question_${question.id}" value="${option}" 
                                   class="sr-only" ${answers[question.id] === option ? 'checked' : ''}>
                            <div class="flex items-center w-full">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 mr-4 flex items-center justify-center group-hover:border-blue-500 transition-colors">
                                    <div class="w-3 h-3 rounded-full bg-blue-600 opacity-0 group-hover:opacity-50 transition-opacity"></div>
                                </div>
                                <div class="flex-1">
                                    <span class="text-sm font-semibold text-gray-500 mr-2">${letter}.</span>
                                    <span class="text-gray-900">${option}</span>
                                </div>
                            </div>
                        </label>
                    `;
                }).join('');
            } else if (question.question_type === 'scale') {
                const currentValue = answers[question.id] || 3;
                return `
                    <div class="bg-white p-6 rounded-lg border">
                        <div class="flex justify-between text-sm text-gray-600 mb-4">
                            <span class="font-medium">Strongly Disagree</span>
                            <span class="font-medium">Neutral</span>
                            <span class="font-medium">Strongly Agree</span>
                        </div>
                        <div class="relative">
                            <input type="range" name="question_${question.id}" min="1" max="5" value="${currentValue}" 
                                   class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer range-slider"
                                   onchange="updateAnswer(${question.id}, this.value); updateRangeDisplay(this.value)">
                            <div class="flex justify-between text-xs text-gray-400 mt-2">
                                <span>1</span>
                                <span>2</span>
                                <span>3</span>
                                <span>4</span>
                                <span>5</span>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <span class="text-lg font-semibold text-blue-600" id="rangeValue">${currentValue}</span>
                            <div class="text-sm text-gray-500 mt-1" id="rangeLabel">${getRangeLabel(currentValue)}</div>
                        </div>
                    </div>
                `;
            } else if (question.question_type === 'true_false') {
                return `
                    <div class="grid grid-cols-2 gap-4">
                        <label class="flex items-center justify-center p-6 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-300 hover:bg-green-50 transition-all duration-200">
                            <input type="radio" name="question_${question.id}" value="true" 
                                   class="sr-only" ${answers[question.id] === 'true' ? 'checked' : ''}>
                            <div class="text-center">
                                <div class="text-3xl mb-2">‚úì</div>
                                <div class="font-semibold text-green-700">True</div>
                            </div>
                        </label>
                        <label class="flex items-center justify-center p-6 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-red-300 hover:bg-red-50 transition-all duration-200">
                            <input type="radio" name="question_${question.id}" value="false" 
                                   class="sr-only" ${answers[question.id] === 'false' ? 'checked' : ''}>
                            <div class="text-center">
                                <div class="text-3xl mb-2">‚úó</div>
                                <div class="font-semibold text-red-700">False</div>
                            </div>
                        </label>
                    </div>
                `;
            } else {
                return `
                    <div class="bg-white p-4 rounded-lg border">
                        <textarea name="question_${question.id}" rows="4" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                  placeholder="Please provide your detailed answer here...">${answers[question.id] || ''}</textarea>
                        <div class="flex justify-between mt-2 text-xs text-gray-500">
                            <span>Be as detailed as possible</span>
                            <span id="charCount_${question.id}">0 characters</span>
                        </div>
                    </div>
                `;
            }
        }

        function getRangeLabel(value) {
            const labels = {
                1: 'Strongly Disagree',
                2: 'Disagree', 
                3: 'Neutral',
                4: 'Agree',
                5: 'Strongly Agree'
            };
            return labels[value] || 'Neutral';
        }

        function updateRangeDisplay(value) {
            document.getElementById('rangeValue').textContent = value;
            document.getElementById('rangeLabel').textContent = getRangeLabel(parseInt(value));
        }

        function updateAnswer(questionId, value) {
            answers[questionId] = value;
        }

        function nextQuestion() {
            // Save current answer
            const currentQuestion = currentTest.questions[currentQuestionIndex];
            const answerInput = document.querySelector(`[name="question_${currentQuestion.id}"]`);
            
            if (answerInput) {
                if (answerInput.type === 'radio') {
                    const checked = document.querySelector(`[name="question_${currentQuestion.id}"]:checked`);
                    answers[currentQuestion.id] = checked ? checked.value : null;
                } else {
                    answers[currentQuestion.id] = answerInput.value;
                }
            }

            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            } else {
                finishTest();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        }

        async function finishTest() {
            try {
                // Submit all answers
                for (const [questionId, answer] of Object.entries(answers)) {
                    if (answer !== null && answer !== '') {
                        await submitAnswer(questionId, answer);
                    }
                }

                // Complete the test
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/psychometric/complete/${currentResponse.id}/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to complete test');
                }

                const results = await response.json();
                displayResults(results);
                
                // Hide test interface, show results
                document.getElementById('testInterface').classList.add('hidden');
                document.getElementById('testResults').classList.remove('hidden');
                
                // Reload previous tests
                loadPreviousTests();
            } catch (error) {
                console.error('Error finishing test:', error);
                showError('Failed to complete test');
            }
        }

        async function submitAnswer(questionId, answer) {
            const token = localStorage.getItem('access_token');
            await fetch(`/psychometric/submit-answer/${currentResponse.id}/`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question: questionId,
                    answer_text: answer,
                    answer_value: typeof answer === 'string' ? parseFloat(answer) : answer
                })
            });
        }

        function displayResults(results) {
            // Update summary cards
            document.getElementById('overallScore').textContent = `${results.overall_score || 0}%`;
            document.getElementById('scoreInterpretation').textContent = getScoreInterpretation(results.overall_score);
            document.getElementById('percentileRank').textContent = `${results.percentile || 0}%`;
            document.getElementById('badgeEarned').textContent = results.badge_earned || 'None';
            
            const container = document.getElementById('resultsContent');
            
            container.innerHTML = `
                <!-- Personality Analysis Chart -->
                <div class="bg-white border rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Personality Analysis</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <canvas id="personalityChart" width="300" height="300"></canvas>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-2">Primary Type</h4>
                                <p class="text-2xl font-bold text-blue-600">${results.personality_type || 'Not Determined'}</p>
                                <p class="text-sm text-gray-600 mt-2">${getPersonalityDescription(results.personality_type)}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-lg mb-2">Overall Score</h4>
                                <p class="text-2xl font-bold text-green-600">${results.overall_score || 0}/100</p>
                                <p class="text-sm text-gray-600 mt-2">${getScoreInterpretation(results.overall_score)}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills Assessment Chart -->
                <div class="bg-white border rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Skills Assessment</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <canvas id="skillsChart" width="400" height="200"></canvas>
                        </div>
                        <div class="space-y-3">
                            ${Object.entries(results.skills_assessment || {}).map(([skill, score]) => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <span class="font-medium text-gray-700">${skill.replace('_', ' ').toUpperCase()}</span>
                                    <div class="flex items-center">
                                        <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                                            <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all duration-500" 
                                                 style="width: ${score * 100}%"></div>
                                        </div>
                                        <span class="text-sm font-semibold text-gray-600 w-12">${Math.round(score * 100)}%</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Career Recommendations -->
                <div class="bg-white border rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Career Recommendations</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${(results.career_recommendations || []).map((career, index) => `
                            <div class="group bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-200 p-4 rounded-lg hover:shadow-md transition-all duration-200">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="text-2xl">${getCareerIcon(career)}</div>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full font-medium">
                                        ${95 - index * 5}% Match
                                    </span>
                                </div>
                                <h4 class="font-semibold text-purple-800 mb-2">${career}</h4>
                                <p class="text-sm text-purple-600">Recommended based on your assessment results</p>
                                <button class="mt-3 text-xs text-purple-700 hover:text-purple-900 font-medium flex items-center">
                                    Learn More <i class="fas fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Strengths & Improvements -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Strengths -->
                    <div class="bg-white border rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-green-700">
                            <i class="fas fa-star mr-2"></i>Your Strengths
                        </h3>
                        <div class="space-y-3">
                            ${(results.strengths || []).map((strength, index) => `
                                <div class="flex items-center p-3 bg-green-50 border-l-4 border-green-400 rounded-r-lg">
                                    <div class="text-green-600 mr-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="flex-1">
                                        <span class="text-green-800 font-medium">${strength}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Areas for Improvement -->
                    <div class="bg-white border rounded-lg p-6">
                        <h3 class="text-lg font-semibold mb-4 text-orange-700">
                            <i class="fas fa-chart-line mr-2"></i>Growth Opportunities
                        </h3>
                        <div class="space-y-3">
                            ${(results.areas_for_improvement || []).map((area, index) => `
                                <div class="flex items-center p-3 bg-orange-50 border-l-4 border-orange-400 rounded-r-lg">
                                    <div class="text-orange-600 mr-3">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <div class="flex-1">
                                        <span class="text-orange-800 font-medium">${area}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Learning Suggestions -->
                <div class="bg-white border rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>Recommended Learning Path
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${(results.learning_suggestions || []).map(suggestion => `
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 p-4 rounded-lg">
                                <div class="text-xl mb-2">üìö</div>
                                <h4 class="font-semibold text-blue-800 mb-2">${suggestion.title || suggestion}</h4>
                                <p class="text-sm text-blue-600 mb-3">${suggestion.description || 'Recommended for your career path'}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                                        ${suggestion.difficulty || 'Beginner'}
                                    </span>
                                    <button class="text-xs text-blue-700 hover:text-blue-900 font-medium">
                                        Start Learning
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Action Steps -->
                <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-6 text-white">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-rocket mr-2 text-yellow-400"></i>Next Steps
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="text-center p-4 bg-gray-700 rounded-lg">
                            <div class="text-2xl mb-2">üé®</div>
                            <h4 class="font-semibold mb-2">Update Your Roadmap</h4>
                            <p class="text-sm text-gray-300">Customize your learning path based on these results</p>
                        </div>
                        <div class="text-center p-4 bg-gray-700 rounded-lg">
                            <div class="text-2xl mb-2">üíº</div>
                            <h4 class="font-semibold mb-2">Build Portfolio</h4>
                            <p class="text-sm text-gray-300">Start projects that align with your strengths</p>
                        </div>
                        <div class="text-center p-4 bg-gray-700 rounded-lg">
                            <div class="text-2xl mb-2">üåê</div>
                            <h4 class="font-semibold mb-2">Join Community</h4>
                            <p class="text-sm text-gray-300">Connect with others in your career field</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Generate charts
            setTimeout(() => {
                generatePersonalityChart(results);
                generateSkillsChart(results.skills_assessment || {});
            }, 100);
        }

        function getScoreInterpretation(score) {
            if (score >= 90) return 'Exceptional performance';
            if (score >= 80) return 'Strong performance';
            if (score >= 70) return 'Good performance';
            if (score >= 60) return 'Average performance';
            return 'Room for improvement';
        }

        function getPersonalityDescription(type) {
            const descriptions = {
                'INTJ': 'Strategic thinker with a plan for everything',
                'ENFP': 'Enthusiastic and creative with strong people skills',
                'ISFJ': 'Warm-hearted and dedicated protector',
                'ESTP': 'Bold and practical, master of all kinds of tools'
            };
            return descriptions[type] || 'Unique personality with diverse strengths';
        }

        function getCareerIcon(career) {
            const icons = {
                'Software Developer': 'üíª',
                'Data Scientist': 'üìà',
                'Product Manager': 'üíº',
                'UX Designer': 'üé®',
                'DevOps Engineer': '‚öôÔ∏è'
            };
            return icons[career] || 'üöÄ';
        }

        function generatePersonalityChart(results) {
            const ctx = document.getElementById('personalityChart');
            if (!ctx) return;
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Analytical', 'Creative', 'Social', 'Practical', 'Leadership'],
                    datasets: [{
                        label: 'Your Profile',
                        data: [
                            (results.traits?.analytical || 0.5) * 100,
                            (results.traits?.creative || 0.5) * 100,
                            (results.traits?.social || 0.5) * 100,
                            (results.traits?.practical || 0.5) * 100,
                            (results.traits?.leadership || 0.5) * 100
                        ],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function generateSkillsChart(skills) {
            const ctx = document.getElementById('skillsChart');
            if (!ctx) return;
            
            const skillNames = Object.keys(skills);
            const skillValues = Object.values(skills).map(v => v * 100);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skillNames.map(name => name.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        label: 'Skill Level (%)',
                        data: skillValues,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(147, 51, 234, 0.8)'
                        ],
                        borderColor: [
                            'rgba(239, 68, 68, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(34, 197, 94, 1)',
                            'rgba(59, 130, 246, 1)',
                            'rgba(147, 51, 234, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        async function loadPreviousTests() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/psychometric/responses/', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load previous tests');
                }

                const tests = await response.json();
                updatePreviousTests(tests);
            } catch (error) {
                console.error('Error loading previous tests:', error);
                showError('Failed to load previous tests');
            }
        }

        function updatePreviousTests(tests) {
            const container = document.getElementById('previousTests');
            
            if (tests.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No previous tests found.</p>';
                return;
            }

            container.innerHTML = tests.map(test => `
                <div class="border rounded-lg p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold">${test.test.name}</h3>
                            <p class="text-sm text-gray-500">
                                Completed: ${new Date(test.completed_at).toLocaleDateString()}
                            </p>
                        </div>
                        <div class="flex space-x-2">
                            ${test.is_completed ? 
                                `<button onclick="viewTestResult(${test.id})" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                    View Results
                                </button>` :
                                `<button onclick="continueTest(${test.id})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Continue
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function viewTestResult(responseId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/psychometric/result/${responseId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load test result');
                }

                const results = await response.json();
                displayResults(results);
                
                // Show results section
                document.getElementById('testResults').classList.remove('hidden');
                document.getElementById('testSelection').classList.add('hidden');
                document.getElementById('testInterface').classList.add('hidden');
            } catch (error) {
                console.error('Error loading test result:', error);
                showError('Failed to load test result');
            }
        }

        // Filter functionality
        function applyFilters() {
            const category = document.getElementById('categoryFilter').value;
            const difficulty = document.getElementById('difficultyFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            
            const testCards = document.querySelectorAll('.test-card');
            let visibleTests = [];
            
            testCards.forEach(card => {
                const cardCategory = card.dataset.category;
                const cardDifficulty = card.dataset.difficulty;
                const cardTitle = card.querySelector('h3').textContent.toLowerCase();
                const cardDescription = card.querySelector('p').textContent.toLowerCase();
                
                let visible = true;
                
                // Apply category filter
                if (category && cardCategory !== category) {
                    visible = false;
                }
                
                // Apply difficulty filter
                if (difficulty && cardDifficulty !== difficulty) {
                    visible = false;
                }
                
                // Apply search filter
                if (search && !cardTitle.includes(search) && !cardDescription.includes(search)) {
                    visible = false;
                }
                
                if (visible) {
                    card.style.display = 'block';
                    visibleTests.push(card);
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update test count
            updateTestCount(visibleTests.length);
            
            // Apply sorting
            if (sort && visibleTests.length > 0) {
                sortTests(visibleTests, sort);
            }
        }
        
        function sortTests(tests, sortType) {
            const container = document.getElementById('availableTests');
            const sortedTests = [...tests];
            
            sortedTests.sort((a, b) => {
                switch (sortType) {
                    case 'popular':
                        // Sort by difficulty (easy first for popularity)
                        const difficultyOrder = { easy: 1, medium: 2, hard: 3 };
                        return difficultyOrder[a.dataset.difficulty] - difficultyOrder[b.dataset.difficulty];
                    case 'newest':
                        // Would need timestamps, for now just reverse order
                        return 0; // Keep current order
                    case 'shortest':
                        // Sort by estimated time if available
                        const timeA = parseInt(a.querySelector('.fas.fa-clock').nextElementSibling.textContent) || 15;
                        const timeB = parseInt(b.querySelector('.fas.fa-clock').nextElementSibling.textContent) || 15;
                        return timeA - timeB;
                    default: // featured
                        return 0;
                }
            });
            
            // Reorder in DOM
            sortedTests.forEach(test => {
                container.appendChild(test);
            });
        }
        
        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableTests();
            loadPreviousTests();
            
            // Filter event listeners
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('difficultyFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
        });
        
        // PDF Report generation
        async function downloadReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Career Assessment Report', 20, 30);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 45);
            
            // Add test name
            doc.text(`Test: ${currentTest?.name || 'Career Assessment'}`, 20, 60);
            
            // Add overall score
            const overallScore = document.getElementById('overallScore').textContent;
            doc.setFontSize(16);
            doc.text(`Overall Score: ${overallScore}`, 20, 80);
            
            // Add personality type if available
            const personalitySection = document.querySelector('#resultsContent .bg-blue-50 p');
            if (personalitySection) {
                doc.text(`Personality Type: ${personalitySection.textContent}`, 20, 100);
            }
            
            // Add strengths
            doc.setFontSize(14);
            doc.text('Strengths:', 20, 120);
            const strengths = document.querySelectorAll('#resultsContent .bg-green-50 span');
            let yPos = 135;
            strengths.forEach((strength, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 30;
                }
                doc.setFontSize(10);
                doc.text(`‚Ä¢ ${strength.textContent}`, 25, yPos);
                yPos += 15;
            });
            
            // Save the PDF
            doc.save('career-assessment-report.pdf');
        }
        
        // Error handling
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
